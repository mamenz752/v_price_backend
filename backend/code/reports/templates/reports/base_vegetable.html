{% extends "config/base_reports.html" %}
{% load static %}
{% load humanize %}

{% block contents %}
<main>
    <div class="container">
        <h2>キャベツ</h2>
        <section class="prediction-summary d-flex gap-4 mb-4">
            <div class="card w-50">
                <div class="card-header text-center">
                    <h5 class="card-subtitle my-2">
                        OO年XX月の価格予測（/kg）
                    </h5>
                </div>
                <div class="card-body">
                    <div class="card-title d-flex justify-content-around align-items-center">
                        <h5 class="min-predict-price text-primary">100円</h5>
                        <p>-</p>
                        <h5 class="median-predict-price text-black">110円</h5>
                        <p>-</p>
                        <h5 class="max-predict-price text-danger">120円</h5>
                    </div>
                </div>
            </div>
            <div class="card w-50">
                <div class="card-header text-center">
                    <h5 class="card-subtitle my-2">
                        OO年XX月の価格見通し
                    </h5>
                </div>
                <div class="card-body">
                    <h5 class="card-title text-center">強もちあい</h5>
                </div>
            </div>            
        </section>

        <section class="yesterday-market-summary">
            <h3>前市集計表（20XX/MM/DD）</h3>
            <div class="card-summary d-flex gap-4 mb-4">
                <div class="card w-50">
                    <div class="card-header text-center">
                        <h5 class="card-subtitle my-2">
                            価格（/kg）
                        </h5>
                    </div>
                    <div class="card-body">
                        <h5 class="card-title text-center">180<span class="text-sm">円</span></h5>
                    </div>
                </div>
                <div class="card w-50">
                    <div class="card-header text-center">
                        <h5 class="card-subtitle my-2">
                            前市比
                        </h5>
                    </div>
                    <div class="card-body">
                        <h5 class="card-title text-center">5%(19円)↓</h5>
                    </div>
                </div>
                <div class="card w-50">
                    <div class="card-header text-center">
                        <h5 class="card-subtitle my-2">
                            入荷量
                        </h5>
                    </div>
                    <div class="card-body">
                        <h5 class="card-title text-center">0.5<span class="text-sm">t</span></h5>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="recently-price-graph">
            <h4 class="contents-header">キャベツの直近価格変動グラフ</h4>
            <div class="container">
                <div class="recently-price-graph-plot d-flex justify-content-center">
                    <canvas
                    id="recently-price-graph-plot"
                    style="height: 400px; margin: 0 auto;"
                    ></canvas>
                </div>
            </div>
            <div class="container mt-4">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th scope="col" style="min-width: 100px;">項目</th>
                                {% for item in markets %}
                                <th scope="col" class="text-center" style="min-width: 60px;">{{ item.target_date|date:"m/d" }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <th scope="row">価格（円/kg）</th>
                                {% for item in markets %}
                                <td class="text-end">{{ item.source_price|default:"-"|floatformat:0|intcomma }}</td>
                                {% endfor %}
                            </tr>
                            <tr>
                                <th scope="row">入荷量（t）</th>
                                {% for item in markets %}
                                <td class="text-end">{{ item.volume|default:"-"|floatformat:2|intcomma }}</td>
                                {% endfor %}
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

         <section class="statistics-market-summary">
            <div class="card-summary d-flex gap-4 mb-4">
                <div class="card w-50">
                    <div class="card-header text-center">
                        <h5 class="card-subtitle my-2">
                            前年比
                        </h5>
                    </div>
                    <div class="card-body">
                        <h5 class="card-title text-center">5%(19円)↓</h5>
                    </div>
                </div>
                <div class="card w-50">
                    <div class="card-header text-center">
                        <h5 class="card-subtitle my-2">
                            前々年比
                        </h5>
                    </div>
                    <div class="card-body">
                       <h5 class="card-title text-center">5%(19円)↓</h5>
                    </div>
                </div>
                <div class="card w-50">
                    <div class="card-header text-center">
                        <h5 class="card-subtitle my-2">
                            平年比
                        </h5>
                    </div>
                    <div class="card-body">
                        <h5 class="card-title text-center">5%(19円)↓</h5>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="predict-price-graph">
            <h4 class="contents-header">キャベツの価格予測傾向</h4>
            <!-- TODO: ここにグラフ作成 -->
            <p>ここに作る</p>
            <div class="container">
                <div class="price_plot">
                    <canvas
                    id="price"
                    style="width: 800px; height: 400px;"
                    ></canvas>
                </div>
            </div>
            <!-- TODO: ここにグラフソース元の表を作成 -->
            <div></div>
            <!-- <div class="button-group">
                <button id="toggleHigh" class="button">高値</button>
                <button id="toggleMedian" class="button">中値</button>
                <button id="toggleLow" class="button">安値</button>
                <button id="toggleRecent" class="button">直近価格</button>
            </div> -->
        </section>
        
        <section class="season-price-graph">
            <h4 class="contents-header">キャベツの長期価格変動</h4>
            <!-- TODO: ここにグラフ作成 -->
            <p>ここに作る</p>
            <div class="container">
                <div class="price_plot">
                    <canvas
                    id="price"
                    style="width: 800px; height: 400px;"
                    ></canvas>
                </div>
            </div>
            <!-- TODO: ここにグラフソース元の表を作成 -->
            <div></div>
            <!-- <div class="button-group">
                <button id="toggleHigh" class="button">高値</button>
                <button id="toggleMedian" class="button">中値</button>
                <button id="toggleLow" class="button">安値</button>
                <button id="toggleRecent" class="button">直近価格</button>
            </div> -->
        </section>
    </div>
</main>
{% endblock contents %}

{% block head %}
{{ block.super }}
<style>
    .table-responsive {
        overflow-x: auto;
    }
    .table {
        width: 100%;
        margin-bottom: 1rem;
        border-collapse: collapse;
    }
    .table th,
    .table td {
        padding: 0.75rem;
        vertical-align: middle;
    }
    .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(0, 0, 0, 0.05);
    }
    .table-hover tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.075);
    }
    .text-end {
        text-align: right;
    }
    .table-light {
        background-color: #f8f9fa;
    }
</style>
{% endblock %}

{% block scripts %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- app static script that renders the chart -->
<script src="{% static 'reports/recentlyPriceGraphConfig.js' %}"></script>
<script>
    // Parse and prepare data
    const data = JSON.parse('{{ recently_price_data|default:"[]"|escapejs }}');
    console.debug('[base_vegetable] Data loaded:', data.length, 'records');

    // Render chart
    const ctx = document.getElementById('recently-price-graph-plot');
    const config = renderRecentlyPriceGraphConfig(data);
    new Chart(ctx, config);
</script>
{% endblock scripts %}