{% extends "config/base_reports.html" %}
{% load static %}
{% load humanize %}

{% block contents %}
<main>
    <div class="container">
        <h2>{{ vegetable_name }}</h2>
        <section class="prediction-summary d-flex flex-column flex-lg-row gap-4 mb-4">
            <div class="card w-100">
                <div class="card-header text-center">
                    <h5 class="card-subtitle my-2">
                        {{ display_date }}の価格予測（/kg）
                    </h5>
                </div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    <div class="d-flex gap-3 align-items-center">
                        <div class="d-flex flex-column align-items-center">
                            <small class="text-muted mb-1">予測最安値</small>
                            <span class="min-predict-price fs-5 fw-bold">{{ min_predict_price|default:"-" }}{% if min_predict_price %}円{% endif %}</span>
                        </div>
                        <span>-</span>
                        <div class="d-flex flex-column align-items-center">
                            <small class="text-muted mb-1">予測中値</small>
                            <span class="median-predict-price fs-5 fw-bold">{{ predict_price|default:"-" }}{% if predict_price %}円{% endif %}</span>
                        </div>
                        <span>-</span>
                        <div class="d-flex flex-column align-items-center">
                            <small class="text-muted mb-1">予測最高値</small>
                            <span class="max-predict-price fs-5 fw-bold">{{ max_predict_price|default:"-" }}{% if max_predict_price %}円{% endif %}</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card w-100">
                <div class="card-header text-center">
                    <h5 class="card-subtitle my-2">
                        {{ display_date }}の価格見通し
                    </h5>
                </div>
                <div class="card-body d-flex align-items-center justify-content-center" style="height: 100%">
                    <p class="card-text text-center fs-5 fw-bold m-0">{{ latest_trend|default:"なし" }}</p>
                </div>
            </div>            
        </section>

        <section class="yesterday-market-summary">
            <h3>前市集計表（{{ recent_date|date:"Y/m/d" }}）</h3>
            <div class="card-summary d-flex flex-column flex-lg-row gap-4 mb-4">
                <div class="card w-100">
                    <div class="card-header text-center">
                        <h5 class="card-subtitle my-2">
                            価格（/kg）
                        </h5>
                    </div>
                    <div class="card-body d-flex align-items-center justify-content-center">
                        <h5 class="card-title m-0">{{ source_price }}<span class="text-sm">円</span></h5>
                    </div>
                </div>
                <div class="card w-100">
                    <div class="card-header text-center">
                        <h5 class="card-subtitle my-2">
                            前市比
                        </h5>
                    </div>
                    <div class="card-body d-flex align-items-center justify-content-between px-4">
                        <div class="flex-grow-1 text-center">
                            <small class="text-muted mb-1">差分</small>
                            <div>
                                {% if price_diff is not None %}
                                    <span class="fs-5 fw-bold">{{ price_diff|floatformat:"0" }}</span>
                                    <span class="fs-6">円</span>
                                {% else %}
                                    <span class="fs-5 fw-bold">-</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="border-start border-2" style="height: 2rem;"></div>
                        <div class="flex-grow-1 text-center">
                            <small class="text-muted mb-1">比率</small>
                            <div>
                                {% if price_diff_ratio is not None %}
                                    <span class="fs-5 fw-bold">{{ price_diff_ratio|floatformat:"1" }}</span>
                                    <span class="fs-6">%</span>
                                {% else %}
                                    <span class="fs-5 fw-bold">-</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="border-start border-2" style="height: 2rem;"></div>
                        <div class="flex-grow-1 text-center">
                            <small class="text-muted mb-1">増減</small>
                            <div>
                                {% if price_diff is not None %}
                                    {% if price_diff > 0 %}
                                        <span class="fs-5 fw-black text-danger">↑</span>
                                    {% elif price_diff < 0 %}
                                        <span class="fs-5 fw-black text-primary">↓</span>
                                    {% else %}
                                        <span class="fs-5 fw-black text-secondary">→</span>
                                    {% endif %}
                                {% else %}
                                    <span class="fs-5 fw-black text-secondary">-</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card w-100">
                    <div class="card-header text-center">
                        <h5 class="card-subtitle my-2">
                            入荷量
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="card-body d-flex align-items-center justify-content-center" style="height: 100%">
                            <p class="card-text text-center fs-5 fw-bold m-0">{{ volume }}<span class="text-sm">t</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="recently-price-graph">
            <h4 class="contents-header">{{ vegetable_name }}の直近価格変動グラフ</h4>
            <div class="container">
                <div class="recently-price-graph-plot d-flex justify-content-center">
                    <canvas
                    id="recently-price-graph-plot"
                    class="chart-canvas"
                    ></canvas>
                </div>
            </div>
            <div class="container mt-4">
                <!-- For large screens -->
                <div class="d-none d-lg-block">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col" style="min-width: 100px;">項目</th>
                                    {% for item in markets|slice:"::-1" %}
                                    <th scope="col" class="text-center" style="min-width: 60px;">{{ item.target_date|date:"m/d" }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <th scope="row">価格（円/kg）</th>
                                    {% for item in markets|slice:"::-1" %}
                                    <td class="text-end">{{ item.source_price|default:"-"|floatformat:0|intcomma }}</td>
                                    {% endfor %}
                                </tr>
                                <tr>
                                    <th scope="row">入荷量（t）</th>
                                    {% for item in markets|slice:"::-1" %}
                                    <td class="text-end">{{ item.volume|default:"-"|floatformat:2|intcomma }}</td>
                                    {% endfor %}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- For small screens -->
                <div class="d-lg-none">
                    {% for item in markets|slice:"::-1" %}
                    <div class="card mb-3">
                        <div class="card-header">
                            {{ item.target_date|date:"Y/m/d" }}
                        </div>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>価格（円/kg）</span>
                                <span class="text-end fw-bold">{{ item.source_price|default:"-"|floatformat:0|intcomma }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>入荷量（t）</span>
                                <span class="text-end fw-bold">{{ item.volume|default:"-"|floatformat:2|intcomma }}</span>
                            </li>
                        </ul>
                    </div>
                    {% empty %}
                    <div class="text-center text-muted">データがありません</div>
                    {% endfor %}
                </div>
            </div>
        </section>

         <section class="statistics-market-summary">
            <div class="card-summary d-flex flex-column flex-lg-row gap-4 mb-4">
                <div class="card w-100">
                    <div class="card-header text-center">
                        <h5 class="card-subtitle my-2">
                            前年比
                        </h5>
                    </div>
                    <div class="card-body d-flex align-items-center justify-content-between px-4">
                        <div class="flex-grow-1 text-center">
                            <small class="text-muted mb-1">差分</small>
                            <div>
                                {% if last_year_diff is not None %}
                                    <span class="fs-5 fw-bold">{{ last_year_diff|floatformat:"0" }}</span>
                                    <span class="fs-6">円</span>
                                {% else %}
                                    <span class="fs-5 fw-bold">-</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="border-start border-2" style="height: 2rem;"></div>
                        <div class="flex-grow-1 text-center">
                            <small class="text-muted mb-1">比率</small>
                            <div>
                                {% if last_year_ratio is not None %}
                                    <span class="fs-5 fw-bold">{{ last_year_ratio|floatformat:"1" }}</span>
                                    <span class="fs-6">%</span>
                                {% else %}
                                    <span class="fs-5 fw-bold">-</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="border-start border-2" style="height: 2rem;"></div>
                        <div class="flex-grow-1 text-center">
                            <small class="text-muted mb-1">増減</small>
                            <div>
                                {% if last_year_diff is not None %}
                                    {% if last_year_diff > 0 %}
                                        <span class="fs-5 fw-black text-danger">↑</span>
                                    {% elif last_year_diff < 0 %}
                                        <span class="fs-5 fw-black text-primary">↓</span>
                                    {% else %}
                                        <span class="fs-5 fw-black text-secondary">→</span>
                                    {% endif %}
                                {% else %}
                                    <span class="fs-5 fw-black text-secondary">-</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card w-100">
                    <div class="card-header text-center">
                        <h5 class="card-subtitle my-2">
                            前々年比
                        </h5>
                    </div>
                    <div class="card-body d-flex align-items-center justify-content-between px-4">
                        <div class="flex-grow-1 text-center">
                            <small class="text-muted mb-1">差分</small>
                            <div>
                                {% if two_years_diff is not None %}
                                    <span class="fs-5 fw-bold">{{ two_years_diff|floatformat:"0" }}</span>
                                    <span class="fs-6">円</span>
                                {% else %}
                                    <span class="fs-5 fw-bold">-</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="border-start border-2" style="height: 2rem;"></div>
                        <div class="flex-grow-1 text-center">
                            <small class="text-muted mb-1">比率</small>
                            <div>
                                {% if two_years_ratio is not None %}
                                    <span class="fs-5 fw-bold">{{ two_years_ratio|floatformat:"1" }}</span>
                                    <span class="fs-6">%</span>
                                {% else %}
                                    <span class="fs-5 fw-bold">-</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="border-start border-2" style="height: 2rem;"></div>
                        <div class="flex-grow-1 text-center">
                            <small class="text-muted mb-1">増減</small>
                            <div>
                                {% if two_years_diff is not None %}
                                    {% if two_years_diff > 0 %}
                                        <span class="fs-5 fw-black text-danger">↑</span>
                                    {% elif two_years_diff < 0 %}
                                        <span class="fs-5 fw-black text-primary">↓</span>
                                    {% else %}
                                        <span class="fs-5 fw-black text-secondary">→</span>
                                    {% endif %}
                                {% else %}
                                    <span class="fs-5 fw-black text-secondary">-</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card w-100">
                    <div class="card-header text-center">
                        <h5 class="card-subtitle my-2">
                            平年比
                        </h5>
                    </div>
                    <div class="card-body d-flex align-items-center justify-content-between px-4">
                        <div class="flex-grow-1 text-center">
                            <small class="text-muted mb-1">差分</small>
                            <div>
                                {% if avg_diff is not None %}
                                    <span class="fs-5 fw-bold">{{ avg_diff|floatformat:"0" }}</span>
                                    <span class="fs-6">円</span>
                                {% else %}
                                    <span class="fs-5 fw-bold">-</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="border-start border-2" style="height: 2rem;"></div>
                        <div class="flex-grow-1 text-center">
                            <small class="text-muted mb-1">比率</small>
                            <div>
                                {% if avg_ratio is not None %}
                                    <span class="fs-5 fw-bold">{{ avg_ratio|floatformat:"1" }}</span>
                                    <span class="fs-6">%</span>
                                {% else %}
                                    <span class="fs-5 fw-bold">-</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="border-start border-2" style="height: 2rem;"></div>
                        <div class="flex-grow-1 text-center">
                            <small class="text-muted mb-1">増減</small>
                            <div>
                                {% if avg_diff is not None %}
                                    {% if avg_diff > 0 %}
                                        <span class="fs-5 fw-black text-danger">↑</span>
                                    {% elif avg_diff < 0 %}
                                       <span class="fs-5 fw-black text-primary">↓</span>
                                    {% else %}
                                        <span class="fs-5 fw-black text-secondary">→</span>
                                    {% endif %}
                                {% else %}
                                    <span class="fs-5 fw-black text-secondary">-</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="predict-price-graph">
            <h4 class="contents-header">{{ vegetable_name }}の価格予測傾向</h4>
            <div class="container">
                <div class="predict-price-graph-plot d-flex justify-content-center">
                    <canvas
                    id="predict-price-graph-plot"
                    class="chart-canvas"
                    ></canvas>
                </div>
            </div>
            <div class="container mt-4">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">期間</th>
                                <th scope="col" class="text-end">価格（円/kg）</th>
                                <th scope="col" class="text-end">最安値（円/kg）</th>
                                <th scope="col" class="text-end">最高値（円/kg）</th>
                            </tr>
                        </thead>
                        <tbody id="prediction-table-body">
                            <!-- JavaScript で動的に生成 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <section class="season-price-graph">
            <h4 class="contents-header">{{ vegetable_name }}の直近3カ月価格変動</h4>
            <div class="container">
                <div class="season-price-graph-plot d-flex justify-content-center">
                    <canvas
                    id="season-price-graph-plot"
                    class="chart-canvas"
                    ></canvas>
                </div>
            </div>
            <div class="container mt-4">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">期間</th>
                                <th scope="col" class="text-end">平均価格（円/kg）</th>
                                <th scope="col" class="text-end">最安値（円/kg）</th>
                                <th scope="col" class="text-end">最高値（円/kg）</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <th scope="row">当年</th>
                                <td class="text-end">{{ season_current_avg|default:"-"|floatformat:0|intcomma }}</td>
                                <td class="text-end">{{ season_current_min|default:"-"|floatformat:0|intcomma }}</td>
                                <td class="text-end">{{ season_current_max|default:"-"|floatformat:0|intcomma }}</td>
                            </tr>
                            <tr>
                                <th scope="row">前年同期</th>
                                <td class="text-end">{{ season_last_year_avg|default:"-"|floatformat:0|intcomma }}</td>
                                <td class="text-end">{{ season_last_year_min|default:"-"|floatformat:0|intcomma }}</td>
                                <td class="text-end">{{ season_last_year_max|default:"-"|floatformat:0|intcomma }}</td>
                            </tr>
                            <tr>
                                <th scope="row">過去5年平均</th>
                                <td class="text-end">{{ season_five_years_avg|default:"-"|floatformat:0|intcomma }}</td>
                                <td class="text-end">{{ season_five_years_min|default:"-"|floatformat:0|intcomma }}</td>
                                <td class="text-end">{{ season_five_years_max|default:"-"|floatformat:0|intcomma }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section class="year-price-graph">
            <h4 class="contents-header">{{ vegetable_name }}の通年価格変動</h4>
            <div class="container">
                <div class="year-price-graph-plot d-flex justify-content-center">
                    <canvas
                    id="year-price-graph-plot"
                    class="chart-canvas"
                    ></canvas>
                </div>
            </div>
        </section>
    </div>
</main>
{% endblock contents %}

{% block head %}
{{ block.super }}
<style>
    @media (min-width: 992px) {
        .chart-canvas {
            height: 300px !important;
        }
    }
    .table-responsive {
        overflow-x: auto;
    }
    .table {
        width: 100%;
        margin-bottom: 1rem;
        border-collapse: collapse;
    }
    .table th,
    .table td {
        padding: 0.75rem;
        vertical-align: middle;
    }
    .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(0, 0, 0, 0.05);
    }
    .table-hover tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.075);
    }
    .text-end {
        text-align: right;
    }
    .table-light {
        background-color: #f8f9fa;
    }
</style>
{% endblock %}

{% block scripts %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Chart.js Adapters for Date/Time -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<!-- app static script that renders the chart -->
<script src="{% static 'reports/graphConfig.js' %}"></script>
<script>
    // Parse and prepare data
    const r_data = JSON.parse('{{ recently_price_data|default:"[]"|escapejs }}');
    const pred_data = JSON.parse('{{ prediction_data|default:"[]"|escapejs }}');
    const s_data = JSON.parse('{{ season_price_data|default:"[]"|escapejs }}');
    const y_data = JSON.parse('{{ year_price_data|default:"[]"|escapejs }}');

    // Render charts
    const r_ctx = document.getElementById('recently-price-graph-plot');
    const p_ctx = document.getElementById('predict-price-graph-plot');
    const s_ctx = document.getElementById('season-price-graph-plot');
    const y_ctx = document.getElementById('year-price-graph-plot');
    const r_config = renderRecentlyPriceGraphConfig(r_data);
    const p_config = renderPredictPriceGraphConfig(pred_data);
    const s_config = renderSeasonPriceGraphConfig(s_data);
    const y_config = renderYearPriceGraphConfig(y_data);
    new Chart(r_ctx, r_config);
    new Chart(p_ctx, p_config);
    new Chart(s_ctx, s_config);
    new Chart(y_ctx, y_config);

    // Generate prediction table with historical and prediction data
    const tableBody = document.getElementById('prediction-table-body');
    if (pred_data && pred_data.length > 0) {
        pred_data.forEach(item => {
            const row = document.createElement('tr');
            
            if (item.data_type === 'historical') {
                // 過去データの行
                row.innerHTML = `
                    <th scope="row" class="bg-light">${item.period} (実績)</th>
                    <td class="text-end bg-light">${item.actual_price != null ? Math.round(item.actual_price).toLocaleString() : '-'}</td>
                    <td class="text-end bg-light">-</td>
                    <td class="text-end bg-light">-</td>
                `;
            } else if (item.data_type === 'prediction') {
                // 予測データの行
                row.innerHTML = `
                    <th scope="row">${item.period} (予測)</th>
                    <td class="text-end">${item.prediction_value != null ? Math.round(item.prediction_value).toLocaleString() : '-'}</td>
                    <td class="text-end">${item.min_price != null ? Math.round(item.min_price).toLocaleString() : '-'}</td>
                    <td class="text-end">${item.max_price != null ? Math.round(item.max_price).toLocaleString() : '-'}</td>
                `;
            }
            tableBody.appendChild(row);
        });
    } else {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="4" class="text-center text-muted">データがありません</td>
        `;
        tableBody.appendChild(row);
    }
</script>
{% endblock scripts %}