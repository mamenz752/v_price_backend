{% extends "config/base.html" %}
{% load static %}

{% block title %}予測モデル管理{% endblock %}

{% block extra_head %}
<style>
  .card {
    margin-bottom: 20px;
  }
  .model-form {
    margin-bottom: 15px;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 5px;
    background-color: #f9f9f9;
  }
  .result-section {
    margin-top: 30px;
  }
  .table-responsive {
    margin-top: 15px;
  }
  .nav-tabs {
    margin-bottom: 15px;
  }
  .tag {
    display: inline-block;
    padding: 2px 5px;
    margin-right: 5px;
    border-radius: 3px;
    font-size: 0.8em;
    background-color: #eef;
  }
  .active-model {
    background-color: #dfd;
  }
  .inactive-model {
    background-color: #fdd;
  }
  .model-stats {
    font-size: 0.9em;
    color: #666;
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <h1>予測モデル管理</h1>
  
  {% if messages %}
    <div class="messages">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}
  
  <div class="row">
    <!-- モデル実行フォーム -->
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">
          <ul class="nav nav-tabs card-header-tabs" id="modelTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <a class="nav-link active" id="single-tab" data-bs-toggle="tab" href="#single" role="tab" aria-controls="single" aria-selected="true">単一モデル実行</a>
            </li>
            <li class="nav-item" role="presentation">
              <a class="nav-link" id="multiple-tab" data-bs-toggle="tab" href="#multiple" role="tab" aria-controls="multiple" aria-selected="false">複数モデル一括実行</a>
            </li>
          </ul>
        </div>
        <div class="card-body">
          <div class="tab-content" id="modelTabsContent">
            <!-- 単一モデル実行フォーム -->
            <div class="tab-pane fade show active" id="single" role="tabpanel" aria-labelledby="single-tab">
              <form method="post" action="{% url 'forecast:run_model' %}" class="model-form">
                {% csrf_token %}
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="model_name" class="form-label">モデル名</label>
                    <select name="model_name" id="model_name" class="form-select" required>
                      <option value="">モデルを選択してください</option>
                      {% for model in model_kinds %}
                        <option value="{{ model.tag_name }}">{{ model.tag_name }} ({{ model.vegetable.name }})</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label for="target_month" class="form-label">対象月</label>
                    <select name="target_month" id="target_month" class="form-select" required>
                      <option value="">月を選択してください</option>
                      {% for month in "123456789101112"|make_list %}
                        <option value="{{ month }}">{{ month }}月</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                <div class="row mb-3">
                  <div class="col-md-12">
                    <label class="form-label">説明変数（複数選択可）</label>
                    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                      {% for var in variables %}
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" name="variables" value="{{ var.id }}" id="var_{{ var.id }}">
                          <label class="form-check-label" for="var_{{ var.id }}">
                            {{ var.name }} ({{ var.previous_term }}期間前)
                          </label>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
                <div class="text-end">
                  <button type="submit" class="btn btn-primary">モデル実行</button>
                </div>
              </form>
            </div>
            
            <!-- 複数モデル一括実行フォーム -->
            <div class="tab-pane fade" id="multiple" role="tabpanel" aria-labelledby="multiple-tab">
              <form method="post" action="{% url 'forecast:run_multiple_models' %}" class="model-form">
                {% csrf_token %}
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label class="form-label">モデル（複数選択可）</label>
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                      {% for model in model_kinds %}
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" name="model_names" value="{{ model.tag_name }}" id="model_{{ model.id }}">
                          <label class="form-check-label" for="model_{{ model.id }}">
                            {{ model.tag_name }} ({{ model.vegetable.name }})
                          </label>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">対象月（複数選択可）</label>
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                      {% for month in "123456789101112"|make_list %}
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" name="target_months" value="{{ month }}" id="month_{{ month }}">
                          <label class="form-check-label" for="month_{{ month }}">
                            {{ month }}月
                          </label>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
                <div class="text-end">
                  <button type="submit" class="btn btn-primary">一括実行</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 実行結果表示 -->
  <div class="result-section">
    <ul class="nav nav-tabs" id="resultTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <a class="nav-link active" id="active-models-tab" data-bs-toggle="tab" href="#active-models" role="tab" aria-controls="active-models" aria-selected="true">アクティブモデル</a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" id="all-models-tab" data-bs-toggle="tab" href="#all-models" role="tab" aria-controls="all-models" aria-selected="false">全モデル</a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" id="evaluations-tab" data-bs-toggle="tab" href="#evaluations" role="tab" aria-controls="evaluations" aria-selected="false">評価指標</a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" id="coefficients-tab" data-bs-toggle="tab" href="#coefficients" role="tab" aria-controls="coefficients" aria-selected="false">係数情報</a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" id="features-tab" data-bs-toggle="tab" href="#features" role="tab" aria-controls="features" aria-selected="false">説明変数セット</a>
      </li>
    </ul>
    
    <div class="tab-content" id="resultTabsContent">
      <!-- アクティブモデル -->
      <div class="tab-pane fade show active" id="active-models" role="tabpanel" aria-labelledby="active-models-tab">
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>ID</th>
                <th>モデル種類</th>
                <th>対象月</th>
                <th>ステータス</th>
                <th>作成日時</th>
              </tr>
            </thead>
            <tbody>
              {% for model in active_models %}
                <tr class="active-model">
                  <td>{{ model.id }}</td>
                  <td>{{ model.model_kind.tag_name }}</td>
                  <td>{{ model.target_month }}月</td>
                  <td>
                    <span class="badge bg-success">アクティブ</span>
                  </td>
                  <td>{{ model.created_at|date:"Y/m/d H:i" }}</td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="5" class="text-center">アクティブなモデルがありません</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- 全モデル -->
      <div class="tab-pane fade" id="all-models" role="tabpanel" aria-labelledby="all-models-tab">
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>ID</th>
                <th>モデル種類</th>
                <th>対象月</th>
                <th>ステータス</th>
                <th>作成日時</th>
              </tr>
            </thead>
            <tbody>
              {% for model in all_models %}
                <tr class="{% if model.is_active %}active-model{% else %}inactive-model{% endif %}">
                  <td>{{ model.id }}</td>
                  <td>{{ model.model_kind.tag_name }}</td>
                  <td>{{ model.target_month }}月</td>
                  <td>
                    {% if model.is_active %}
                      <span class="badge bg-success">アクティブ</span>
                    {% else %}
                      <span class="badge bg-secondary">非アクティブ</span>
                    {% endif %}
                  </td>
                  <td>{{ model.created_at|date:"Y/m/d H:i" }}</td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="5" class="text-center">モデルがありません</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- 評価指標 -->
      <div class="tab-pane fade" id="evaluations" role="tabpanel" aria-labelledby="evaluations-tab">
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>ID</th>
                <th>R値</th>
                <th>R²</th>
                <th>調整済みR²</th>
                <th>RMSE</th>
                <th>F値の有意性</th>
                <th>作成日時</th>
              </tr>
            </thead>
            <tbody>
              {% for eval in model_evaluations %}
                <tr>
                  <td>{{ eval.id }}</td>
                  <td>{{ eval.multi_r|floatformat:4 }}</td>
                  <td>{{ eval.heavy_r2|floatformat:4 }}</td>
                  <td>{{ eval.adjusted_r2|floatformat:4 }}</td>
                  <td>{{ eval.rmse|floatformat:4 }}</td>
                  <td>{{ eval.sign_f|floatformat:6 }}</td>
                  <td>{{ eval.created_at|date:"Y/m/d H:i" }}</td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="7" class="text-center">評価指標がありません</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- 係数情報 -->
      <div class="tab-pane fade" id="coefficients" role="tabpanel" aria-labelledby="coefficients-tab">
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>変数名</th>
                <th>期間</th>
                <th>係数</th>
                <th>t値</th>
                <th>p値</th>
                <th>標準誤差</th>
                <th>作成日時</th>
              </tr>
            </thead>
            <tbody>
              {% for coef in model_coefficients %}
                <tr>
                  <td>{{ coef.variable.name }}</td>
                  <td>{% if coef.variable.previous_term > 0 %}{{ coef.variable.previous_term }} 期間前{% else %}-{% endif %}</td>
                  <td>{{ coef.coef|floatformat:6 }}</td>
                  <td>{{ coef.value_t|floatformat:4 }}</td>
                  <td>{{ coef.sign_p|floatformat:6 }}</td>
                  <td>{{ coef.standard_error|floatformat:6 }}</td>
                  <td>{{ coef.created_at|date:"Y/m/d H:i" }}</td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="7" class="text-center">係数情報がありません</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- 説明変数セット -->
      <div class="tab-pane fade" id="features" role="tabpanel" aria-labelledby="features-tab">
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>モデル種類</th>
                <th>対象月</th>
                <th>説明変数名</th>
                <th>期間</th>
                <th>作成日時</th>
              </tr>
            </thead>
            <tbody>
              {% for feature in feature_sets %}
                <tr>
                  <td>{{ feature.model_kind.tag_name }}</td>
                  <td>{{ feature.target_month }}月</td>
                  <td>{{ feature.variable.name }}</td>
                  <td>{{ feature.variable.previous_term }}期間前</td>
                  <td>{{ feature.created_at|date:"Y/m/d H:i" }}</td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="5" class="text-center">説明変数セットがありません</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // タブの切り替え
    var triggerTabList = [].slice.call(document.querySelectorAll('#modelTabs a, #resultTabs a'));
    triggerTabList.forEach(function (triggerEl) {
      var tabTrigger = new bootstrap.Tab(triggerEl);
      triggerEl.addEventListener('click', function (event) {
        event.preventDefault();
        tabTrigger.show();
      });
    });
    
    // チェックボックス選択の便利機能
    document.querySelectorAll('.form-check-input').forEach(function(checkbox) {
      checkbox.addEventListener('change', function() {
        // 必要に応じて追加機能
      });
    });
  });
</script>
{% endblock %}
